!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReactDnDTouchBackend=t()}(this,(function(){"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function n(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i,r="production",s=function(e,t,n,o,i,s,a,u){if("production"!==r&&void 0===t)throw new Error("invariant requires an error message argument");if(!e){var d;if(void 0===t)d=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var c=[n,o,i,s,a,u],h=0;(d=new Error(t.replace(/%s/g,(function(){return c[h++]})))).name="Invariant Violation"}throw d.framesToPop=1,d}};!function(e){e.mouse="mouse",e.touch="touch",e.keyboard="keyboard"}(i||(i={}));var a={Left:1,Right:2,Center:4},u={Left:0,Center:1,Right:2};function d(e){return void 0===e.button||e.button===u.Left}var c=1;function h(e){return function(e){return!!e.targetTouches}(e)?function(e){if(1===e.targetTouches.length)return h(e.targetTouches[0])}(e):{x:e.clientX,y:e.clientY}}var l,v=function(){var e=!1;try{addEventListener("test",(function(){}),Object.defineProperty({},"passive",{get:function(){return e=!0,!0}}))}catch(e){}return e}(),f=function(){function t(n,o){var i=this;e(this,t),this.enableTouchEvents=!0,this.enableMouseEvents=!1,this.enableKeyboardEvents=!1,this.ignoreContextMenu=!1,this.enableHoverOutsideTarget=!1,this.touchSlop=0,this.scrollAngleRanges=void 0,this.context=o,this.delayTouchStart=n.delayTouchStart||n.delay||0,this.delayMouseStart=n.delayMouseStart||n.delay||0,Object.keys(n).forEach((function(e){null!=n[e]&&(i[e]=n[e])}))}return n(t,[{key:"window",get:function(){return this.context&&this.context.window?this.context.window:"undefined"!=typeof window?window:void 0}},{key:"document",get:function(){if(this.window)return this.window.document}}]),t}(),p=(o(l={},i.mouse,{start:"mousedown",move:"mousemove",end:"mouseup",contextmenu:"contextmenu"}),o(l,i.touch,{start:"touchstart",move:"touchmove",end:"touchend"}),o(l,i.keyboard,{keydown:"keydown"}),l),m=function(){function t(n,o,r){var s=this;e(this,t),this.getSourceClientOffset=function(e){return function(e){var t=e.nodeType===c?e:e.parentElement;if(t){var n=t.getBoundingClientRect(),o=n.top;return{x:n.left,y:o}}}(s.sourceNodes[e])},this.handleTopMoveStartCapture=function(e){d(e)&&(s.moveStartSourceIds=[])},this.handleMoveStart=function(e){Array.isArray(s.moveStartSourceIds)&&s.moveStartSourceIds.unshift(e)},this.handleTopMoveStart=function(e){if(d(e)){var t=h(e);t&&(s._mouseClientOffset=t),s.waitingForDelay=!1}},this.handleTopMoveStartDelay=function(e){if(d(e)){var t=e.type===p.touch.start?s.options.delayTouchStart:s.options.delayMouseStart;s.timeout=setTimeout(s.handleTopMoveStart.bind(s,e),t),s.waitingForDelay=!0}},this.handleTopMoveCapture=function(){s.dragOverTargetIds=[]},this.handleMove=function(e,t){s.dragOverTargetIds&&s.dragOverTargetIds.unshift(t)},this.handleTopMove=function(e){if(s.timeout&&clearTimeout(s.timeout),s.document&&!s.waitingForDelay){var t,n,o,i,r=s.moveStartSourceIds,a=s.dragOverTargetIds,u=s.options.enableHoverOutsideTarget,d=h(e);if(d)if(s._isScrolling||!s.monitor.isDragging()&&function(e,t,n,o,i){if(!i)return!1;for(var r=180*Math.atan2(o-t,n-e)/Math.PI+180,s=0;s<i.length;++s)if((null==i[s].start||r>=i[s].start)&&(null==i[s].end||r<=i[s].end))return!0;return!1}(s._mouseClientOffset.x||0,s._mouseClientOffset.y||0,d.x,d.y,s.options.scrollAngleRanges))s._isScrolling=!0;else if(!s.monitor.isDragging()&&s._mouseClientOffset.hasOwnProperty("x")&&r&&(t=s._mouseClientOffset.x||0,n=s._mouseClientOffset.y||0,o=d.x,i=d.y,Math.sqrt(Math.pow(Math.abs(o-t),2)+Math.pow(Math.abs(i-n),2))>(s.options.touchSlop?s.options.touchSlop:0))&&(s.moveStartSourceIds=void 0,s.actions.beginDrag(r,{clientOffset:s._mouseClientOffset,getSourceClientOffset:s.getSourceClientOffset,publishSource:!1})),s.monitor.isDragging()){var c=s.sourceNodes[s.monitor.getSourceId()];s.installSourceNodeRemovalObserver(c),s.actions.publishDragSource(),e.preventDefault();var l=(a||[]).map((function(e){return s.targetNodes[e]})),v=s.options.getDropTargetElementsAtPoint?s.options.getDropTargetElementsAtPoint(d.x,d.y,l):s.document.elementsFromPoint(d.x,d.y),f=[];for(var p in v)if(v.hasOwnProperty(p)){var m=v[p];for(f.push(m);m;)m=m.parentElement,-1===f.indexOf(m)&&f.push(m)}var g=f.filter((function(e){return l.indexOf(e)>-1})).map((function(e){for(var t in s.targetNodes)if(e===s.targetNodes[t])return t})).filter((function(e){return!!e})).filter((function(e,t,n){return n.indexOf(e)===t}));if(u)for(var w in s.targetNodes)if(s.targetNodes[w]&&s.targetNodes[w].contains(c)&&-1===g.indexOf(w)){g.unshift(w);break}g.reverse(),s.actions.hover(g,{clientOffset:d})}}},this.handleTopMoveEndCapture=function(e){s._isScrolling=!1,function(e){return void 0===e.buttons||0==(e.buttons&a.Left)}(e)&&(s.monitor.isDragging()&&!s.monitor.didDrop()?(e.preventDefault(),s._mouseClientOffset={},s.uninstallSourceNodeRemovalObserver(),s.actions.drop(),s.actions.endDrag()):s.moveStartSourceIds=void 0)},this.handleCancelOnEscape=function(e){"Escape"===e.key&&s.monitor.isDragging()&&(s._mouseClientOffset={},s.uninstallSourceNodeRemovalObserver(),s.actions.endDrag())},this.options=new f(r,o),this.actions=n.getActions(),this.monitor=n.getMonitor(),this.sourceNodes={},this.sourcePreviewNodes={},this.sourcePreviewNodeOptions={},this.targetNodes={},this.listenerTypes=[],this._mouseClientOffset={},this._isScrolling=!1,this.options.enableMouseEvents&&this.listenerTypes.push(i.mouse),this.options.enableTouchEvents&&this.listenerTypes.push(i.touch),this.options.enableKeyboardEvents&&this.listenerTypes.push(i.keyboard)}return n(t,[{key:"setup",value:function(){this.window&&(s(!t.isSetUp,"Cannot have two Touch backends at the same time."),t.isSetUp=!0,this.addEventListener(this.window,"start",this.getTopMoveStartHandler()),this.addEventListener(this.window,"start",this.handleTopMoveStartCapture,!0),this.addEventListener(this.window,"move",this.handleTopMove),this.addEventListener(this.window,"move",this.handleTopMoveCapture,!0),this.addEventListener(this.window,"end",this.handleTopMoveEndCapture,!0),this.options.enableMouseEvents&&!this.options.ignoreContextMenu&&this.addEventListener(this.window,"contextmenu",this.handleTopMoveEndCapture),this.options.enableKeyboardEvents&&this.addEventListener(this.window,"keydown",this.handleCancelOnEscape,!0))}},{key:"teardown",value:function(){this.window&&(t.isSetUp=!1,this._mouseClientOffset={},this.removeEventListener(this.window,"start",this.handleTopMoveStartCapture,!0),this.removeEventListener(this.window,"start",this.handleTopMoveStart),this.removeEventListener(this.window,"move",this.handleTopMoveCapture,!0),this.removeEventListener(this.window,"move",this.handleTopMove),this.removeEventListener(this.window,"end",this.handleTopMoveEndCapture,!0),this.options.enableMouseEvents&&!this.options.ignoreContextMenu&&this.removeEventListener(this.window,"contextmenu",this.handleTopMoveEndCapture),this.options.enableKeyboardEvents&&this.removeEventListener(this.window,"keydown",this.handleCancelOnEscape,!0),this.uninstallSourceNodeRemovalObserver())}},{key:"addEventListener",value:function(e,t,n,o){var i=v?{capture:o,passive:!1}:o;this.listenerTypes.forEach((function(o){var r=p[o][t];r&&e.addEventListener(r,n,i)}))}},{key:"removeEventListener",value:function(e,t,n,o){var i=v?{capture:o,passive:!1}:o;this.listenerTypes.forEach((function(o){var r=p[o][t];r&&e.removeEventListener(r,n,i)}))}},{key:"connectDragSource",value:function(e,t){var n=this,o=this.handleMoveStart.bind(this,e);return this.sourceNodes[e]=t,this.addEventListener(t,"start",o),function(){delete n.sourceNodes[e],n.removeEventListener(t,"start",o)}}},{key:"connectDragPreview",value:function(e,t,n){var o=this;return this.sourcePreviewNodeOptions[e]=n,this.sourcePreviewNodes[e]=t,function(){delete o.sourcePreviewNodes[e],delete o.sourcePreviewNodeOptions[e]}}},{key:"connectDropTarget",value:function(e,t){var n=this;if(!this.document)return function(){return null};var o=function(o){if(n.document&&n.monitor.isDragging()){var i;switch(o.type){case p.mouse.move:i={x:o.clientX,y:o.clientY};break;case p.touch.move:i={x:o.touches[0].clientX,y:o.touches[0].clientY}}var r=null!=i?n.document.elementFromPoint(i.x,i.y):void 0,s=r&&t.contains(r);return r===t||s?n.handleMove(o,e):void 0}};return this.addEventListener(this.document.body,"move",o),this.targetNodes[e]=t,function(){n.document&&(delete n.targetNodes[e],n.removeEventListener(n.document.body,"move",o))}}},{key:"getTopMoveStartHandler",value:function(){return this.options.delayTouchStart||this.options.delayMouseStart?this.handleTopMoveStartDelay:this.handleTopMoveStart}},{key:"installSourceNodeRemovalObserver",value:function(e){var t=this;this.uninstallSourceNodeRemovalObserver(),this.draggedSourceNode=e,this.draggedSourceNodeRemovalObserver=new MutationObserver((function(){e&&!e.parentElement&&(t.resurrectSourceNode(),t.uninstallSourceNodeRemovalObserver())})),e&&e.parentElement&&this.draggedSourceNodeRemovalObserver.observe(e.parentElement,{childList:!0})}},{key:"resurrectSourceNode",value:function(){this.document&&this.draggedSourceNode&&(this.draggedSourceNode.style.display="none",this.draggedSourceNode.removeAttribute("data-reactid"),this.document.body.appendChild(this.draggedSourceNode))}},{key:"uninstallSourceNodeRemovalObserver",value:function(){this.draggedSourceNodeRemovalObserver&&this.draggedSourceNodeRemovalObserver.disconnect(),this.draggedSourceNodeRemovalObserver=void 0,this.draggedSourceNode=void 0}},{key:"window",get:function(){return this.options.window}},{key:"document",get:function(){if(this.window)return this.window.document}}]),t}();return function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new m(e,t,n)}}));
